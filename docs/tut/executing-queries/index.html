
<!DOCTYPE html>
<html class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Documentation for Aqueduct, a Dart server-side framework.">
      
      
      
      
        <link rel="shortcut icon" href="../../assets/images/favicon.png">
      
      <meta name="generator" content="mkdocs-0.16.1, mkdocs-material-1.1.1">
    
    
      
        <title>3. Executing Database Queries - Aqueduct</title>
      
    
    
      <script src="../../assets/javascripts/modernizr-56ade86843.js"></script>
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application-4ebe3f1d68.css">
      
    
    
      
        
        
        
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
      <link rel="stylesheet" href="../../style/css/override.css">
    
    
  </head>
  
  
  
  
    <body>
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="search">
    <label class="md-overlay" data-md-component="overlay" for="drawer"></label>
    
      <header class="md-header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <a href="../.." title="Aqueduct" class="md-icon md-icon--home md-header-nav__button">
          </a>
        
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <span class="md-flex__ellipsis md-header-nav__title">
          
            
              
                <span class="md-header-nav__parent">
                  Tutorial
                </span>
              
            
            3. Executing Database Queries
          
        </span>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
          
<div class="md-search" data-md-component="search">
  <div class="md-search__overlay"></div>
  <div class="md-search__inner">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" accesskey="s" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query">
      <label class="md-icon md-search__icon" for="search"></label>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result"></div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <div class="md-header-nav__source">
          
            


  


  <a href="https://github.com/stablekernel/aqueduct" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

          
        </div>
      </div>
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="drawer">
    
      <i class="md-icon md-icon--home md-nav__button"></i>
    
    Aqueduct
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/stablekernel/aqueduct" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2" checked>
    
    <label class="md-nav__link" for="nav-2">
      Tutorial
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Tutorial
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../getting-started/" title="1. Getting Started" class="md-nav__link">
      1. Getting Started
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../writing-tests/" title="2. Writing Tests" class="md-nav__link">
      2. Writing Tests
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="toc">
        3. Executing Database Queries
      </label>
    
    <a href="./" title="3. Executing Database Queries" class="md-nav__link md-nav__link--active">
      3. Executing Database Queries
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#building-a-data-model" title="Building a Data Model" class="md-nav__link">
    Building a Data Model
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#importing-managedobjects" title="Importing ManagedObjects" class="md-nav__link">
    Importing ManagedObjects
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#defining-a-context" title="Defining a Context" class="md-nav__link">
    Defining a Context
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#executing-queries_1" title="Executing Queries" class="md-nav__link">
    Executing Queries
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configuring-a-database" title="Configuring a Database" class="md-nav__link">
    Configuring a Database
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-more-you-know-query-parameters-and-http-headers" title="The more you know: Query Parameters and HTTP Headers" class="md-nav__link">
    The more you know: Query Parameters and HTTP Headers
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#next-relationships-and-joins" title="Next: Relationships and Joins" class="md-nav__link">
    Next: Relationships and Joins
  </a>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../model-relationships-and-joins/" title="4. Advanced Database Queries" class="md-nav__link">
      4. Advanced Database Queries
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../deploying-and-other-fun-things/" title="5. Deploying" class="md-nav__link">
      5. Deploying
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      HTTP
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        HTTP
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../http/overview/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../http/structure/" title="Application Structure" class="md-nav__link">
      Application Structure
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../http/request_and_response/" title="Request and Response Objects" class="md-nav__link">
      Request and Response Objects
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../http/request_controller/" title="Handling Requests: Fundamentals" class="md-nav__link">
      Handling Requests: Fundamentals
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../http/routing/" title="Routing" class="md-nav__link">
      Routing
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../http/request_sink/" title="Initialization and the RequestSink" class="md-nav__link">
      Initialization and the RequestSink
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../http/http_controller/" title="Handling Requests: HTTPController" class="md-nav__link">
      Handling Requests: HTTPController
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../http/configure/" title="Configuration" class="md-nav__link">
      Configuration
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Database/ORM
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Database/ORM
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../db/overview/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../db/modeling_data/" title="Modeling Data" class="md-nav__link">
      Modeling Data
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../db/serialization/" title="Storage, Serialization and Deserialization" class="md-nav__link">
      Storage, Serialization and Deserialization
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../db/executing_queries/" title="Executing Queries" class="md-nav__link">
      Executing Queries
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../db/advanced_queries/" title="Advanced Queries" class="md-nav__link">
      Advanced Queries
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../db/validations/" title="Validations" class="md-nav__link">
      Validations
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../db/db_tools/" title="Migration and Tooling" class="md-nav__link">
      Migration and Tooling
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../db/inside_the_db/" title="Inside the DB" class="md-nav__link">
      Inside the DB
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      OAuth 2.0
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        OAuth 2.0
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../auth/overview/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../auth/server/" title="Setting up Authorization" class="md-nav__link">
      Setting up Authorization
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../auth/authorizer/" title="Protected Routes" class="md-nav__link">
      Protected Routes
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../auth/controllers/" title="Issuing Access Tokens" class="md-nav__link">
      Issuing Access Tokens
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../auth/cli/" title="Creating OAuth 2.0 Clients" class="md-nav__link">
      Creating OAuth 2.0 Clients
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../auth/what_is_oauth/" title="What is OAuth 2.0?" class="md-nav__link">
      What is OAuth 2.0?
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      Testing
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        Testing
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../testing/overview/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../testing/harness/" title="Test Harness" class="md-nav__link">
      Test Harness
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../testing/test_client/" title="Writing Tests and the TestClient" class="md-nav__link">
      Writing Tests and the TestClient
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7">
    
    <label class="md-nav__link" for="nav-7">
      Deployment
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        Deployment
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../deploy/overview/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../deploy/deploy_local/" title="Deploy Locally" class="md-nav__link">
      Deploy Locally
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../deploy/deploy_heroku/" title="Deploy on Heroku" class="md-nav__link">
      Deploy on Heroku
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../deploy/deploy_aws/" title="Deploy on AWS" class="md-nav__link">
      Deploy on AWS
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../deploy/script/" title="Deploying without aqueduct serve" class="md-nav__link">
      Deploying without aqueduct serve
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#building-a-data-model" title="Building a Data Model" class="md-nav__link">
    Building a Data Model
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#importing-managedobjects" title="Importing ManagedObjects" class="md-nav__link">
    Importing ManagedObjects
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#defining-a-context" title="Defining a Context" class="md-nav__link">
    Defining a Context
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#executing-queries_1" title="Executing Queries" class="md-nav__link">
    Executing Queries
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configuring-a-database" title="Configuring a Database" class="md-nav__link">
    Configuring a Database
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-more-you-know-query-parameters-and-http-headers" title="The more you know: Query Parameters and HTTP Headers" class="md-nav__link">
    The more you know: Query Parameters and HTTP Headers
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#next-relationships-and-joins" title="Next: Relationships and Joins" class="md-nav__link">
    Next: Relationships and Joins
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
               
                 <a href="https://github.com/stablekernel/aqueduct/edit/master/docs/tut/executing-queries.md" title="Edit this page" class="md-icon md-content__edit">edit</a>
               
              
                
                <h1 id="executing-queries">Executing Queries</h1>
<p>Now that you've seen how to route HTTP requests and respond to them, we'll do something useful with those requests: like interacting with a database. We will continue to build on the last chapter project, <code>quiz</code>, by storing the questions in a database and retrieving them from the database.</p>
<h2 id="building-a-data-model">Building a Data Model</h2>
<p>Aqueduct has a built-in ORM (some of which is modeled after the iOS/macOS Core Data framework). Like all ORMs, rows of a database are mapped to objects. In Aqueduct, these objects are of type <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/ManagedObject-class.html">ManagedObject&lt;T&gt;</a>. Let's define a managed object that represents a 'question'. Create a new directory in <code>lib</code> named <code>model</code>, and then add a new file to it named <code>question.dart</code> (thus, <code>lib/model/question.dart</code>).</p>
<p>A managed object is a subclass of <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/ManagedObject-class.html">ManagedObject&lt;T&gt;</a>, where <code>T</code> is a <em>persistent type</em>. A persistent type is a simple Dart class that maps to a database table. Each of its properties maps to a column in that table. By convention, but not required, persistent types are prefixed with '_'. In <code>question.dart</code>, let's define a persistent type for a question:</p>
<div class="codehilite"><pre><span></span><span class="k">import</span> <span class="s1">&#39;package:quiz/quiz.dart&#39;</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">_Question</span> <span class="p">{</span>
  <span class="err">@</span><span class="n">ManagedColumnAttributes</span><span class="p">(</span><span class="nl">primaryKey:</span> <span class="kc">true</span><span class="p">,</span> <span class="nl">databaseType:</span> <span class="n">PropertyType</span><span class="p">.</span><span class="n">bigInteger</span><span class="p">,</span> <span class="nl">autoincrement:</span> <span class="kc">true</span><span class="p">)</span>
  <span class="kt">int</span> <span class="n">index</span><span class="p">;</span>

  <span class="kt">String</span> <span class="n">description</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>Each property in a persistent type can be marked with <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/ManagedColumnAttributes-class.html">ManagedColumnAttributes</a> metadata that defines how the underlying database column is defined. The <code>index</code> property of <code>_Question</code> is the primary key column and a "big" integer. The autoincrement flag lets the database generate this value when a new question is inserted. Because it is quite common to have a primary key that is a big integer and autoincrementing, there is shorthand for it. Replace the metadata with the <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/managedPrimaryKey-constant.html">managedPrimaryKey</a> shorthand:</p>
<div class="codehilite"><pre><span></span><span class="kd">class</span> <span class="nc">_Question</span> <span class="p">{</span>
  <span class="err">@</span><span class="n">managedPrimaryKey</span>
  <span class="kt">int</span> <span class="n">index</span><span class="p">;</span>

  <span class="kt">String</span> <span class="n">description</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p><em>All managed objects must have exactly one property with <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/ManagedEntity/primaryKey.html">primaryKey</a> set to true.</em> Other interesting flags for <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/ManagedColumnAttributes-class.html">ManagedColumnAttributes</a> are <code>indexed</code>, <code>nullable</code> and <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/ManagedAttributeDescription/defaultValue.html">defaultValue</a>. If a property does not have <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/ManagedColumnAttributes-class.html">ManagedColumnAttributes</a>, it is still a persistent property. All of the , it's just a normal column and its database type is inferred from its Dart type. Supported Dart types are <code>int</code>, <code>double</code>, <code>String</code>, <code>DateTime</code> and <code>bool</code>.</p>
<p>Once a persistent type has been defined, you must also declare a corresponding subclass of <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/ManagedObject-class.html">ManagedObject</a>. At the top of <code>question.dart</code>, but underneath the import, add the following:</p>
<div class="codehilite"><pre><span></span><span class="k">import</span> <span class="s1">&#39;package:quiz/quiz.dart&#39;</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">Question</span> <span class="kd">extends</span> <span class="n">ManagedObject</span><span class="o">&lt;</span><span class="n">_Question</span><span class="o">&gt;</span> <span class="kd">implements</span> <span class="n">_Question</span> <span class="p">{}</span>
<span class="kd">class</span> <span class="nc">_Question</span> <span class="p">{</span>
  <span class="err">@</span><span class="n">managedPrimaryKey</span>
  <span class="kt">int</span> <span class="n">index</span><span class="p">;</span>

  <span class="kt">String</span> <span class="n">description</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>This dual-class setup is important and necessary for using Aqueduct's ORM. The persistent type - the plain Dart class that starts with an underscore - represents a database table. Each property of the persistent type is a column in that database table. The name of the database table matches the name of the class (here, <code>_Question</code>).</p>
<p>The <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/ManagedObject-class.html">ManagedObject</a> subclass is the type you work with in your code. Its associated persistent type appears twice in its declaration: as the type argument to <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/ManagedObject-class.html">ManagedObject</a> (<code>ManagedObject&lt;_Question&gt;</code>) and as an interface (<code>implements _Question</code>). A <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/ManagedObject-class.html">ManagedObject</a> may have properties and methods of its own, but those are <em>not</em> backed by a database column.</p>
<h2 id="importing-managedobjects">Importing ManagedObjects</h2>
<p>As your code progresses, those <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/ManagedObject-class.html">ManagedObject&lt;T&gt;</a>s will have relationships with other <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/ManagedObject-class.html">ManagedObject&lt;T&gt;</a>s and be used in your request handling code. Additionally, the tools that generate database schemas and 'compile' the declarations of <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/ManagedObject-class.html">ManagedObject&lt;T&gt;</a> also need to see the definitions. Therefore, <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/ManagedObject-class.html">ManagedObject</a> declarations must be visible to the rest of your application.</p>
<p>The best practice is to declare each <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/ManagedObject-class.html">ManagedObject&lt;T&gt;</a> in its own file and create a file that exports all <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/ManagedObject-class.html">ManagedObject&lt;T&gt;</a>s. Create a new file in <code>lib</code> named <code>model.dart</code>. In this file, export <code>model/question.dart</code>:</p>
<div class="codehilite"><pre><span></span><span class="k">export</span> <span class="s1">&#39;model/question.dart&#39;</span><span class="p">;</span>
</pre></div>


<p>The <code>model.dart</code> file exports all of your <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/ManagedObject-class.html">ManagedObject</a> declarations. Now, to make all of your managed objects visible, export <code>model.dart</code> in <code>quiz.dart</code>:</p>
<div class="codehilite"><pre><span></span><span class="k">export</span> <span class="s1">&#39;dart:async&#39;</span><span class="p">;</span>
<span class="k">export</span> <span class="s1">&#39;package:aqueduct/aqueduct.dart&#39;</span><span class="p">;</span>

<span class="k">export</span> <span class="s1">&#39;sink.dart&#39;</span><span class="p">;</span>

<span class="c1">// Add this export:</span>
<span class="k">export</span> <span class="s1">&#39;model.dart&#39;</span><span class="p">;</span>
</pre></div>


<p>Now, every file in your application that import the application package will see the managed object declarations - and more importantly, the tools will see those declarations, too.</p>
<h2 id="defining-a-context">Defining a Context</h2>
<p>In order for an application to work with a database, it needs a <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/ManagedContext-class.html">ManagedContext</a>. A <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/ManagedContext-class.html">ManagedContext</a> is the facilitator between your code and a database. It is made up of two components, a <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/ManagedDataModel-class.html">ManagedDataModel</a> (the thing that keeps track of all of your managed object types) and <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/PersistentStore-class.html">PersistentStore</a> (the thing that talks to the database). These objects are set up in a <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/RequestSink-class.html">RequestSink</a>. In <code>sink.dart</code>, add the following code to the constructor for <code>QuizRequestSink</code> and define a new property:</p>
<div class="codehilite"><pre><span></span><span class="kd">class</span> <span class="nc">QuizRequestSink</span> <span class="kd">extends</span> <span class="n">RequestSink</span> <span class="p">{</span>
  <span class="n">QuizRequestSink</span><span class="p">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="kt">String</span><span class="p">,</span> <span class="kt">dynamic</span><span class="o">&gt;</span> <span class="n">options</span><span class="p">)</span> <span class="o">:</span> <span class="k">super</span><span class="p">(</span><span class="n">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="n">dataModel</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ManagedDataModel</span><span class="p">.</span><span class="n">fromCurrentMirrorSystem</span><span class="p">();</span>
    <span class="kd">var</span> <span class="n">persistentStore</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PostgreSQLPersistentStore</span><span class="p">.</span><span class="n">fromConnectionInfo</span><span class="p">(</span>
      <span class="s2">&quot;dart&quot;</span><span class="p">,</span> <span class="s2">&quot;dart&quot;</span><span class="p">,</span> <span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="m">5432</span><span class="p">,</span> <span class="s2">&quot;dart_test&quot;</span><span class="p">);</span>
    <span class="n">context</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ManagedContext</span><span class="p">(</span><span class="n">dataModel</span><span class="p">,</span> <span class="n">persistentStore</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">ManagedContext</span> <span class="n">context</span><span class="p">;</span>

  <span class="p">...</span>
</pre></div>


<p>(In the future, we'll allow this information to be passed from a configuration file. But for now, we'll do it manually.)</p>
<p>A <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/ManagedDataModel-class.html">ManagedDataModel</a> is initialized with its named constructor <code>fromCurrentMirrorSystem</code>. This constructor uses reflection to find every <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/ManagedObject-class.html">ManagedObject&lt;T&gt;</a> subclass in your application and compile a data model from them. (This is why it is important to export managed objects the way it was done in the previous section.)</p>
<p>The persistent store is a specific implementation of a persistent store, <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/PostgreSQLPersistentStore-class.html">PostgreSQLPersistentStore</a>. It is initialized with information necessary to connect to a database. A <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/ManagedContext-class.html">ManagedContext</a> simply ties those two things together.</p>
<p>(By the way, the interface for <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/PersistentStore-class.html">PersistentStore</a> can be implemented for different flavors of SQL and even non-SQL databases. We just so happen to prefer PostgreSQL, so we've already built that one.)</p>
<p>When a <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/ManagedContext-class.html">ManagedContext</a> is created, it becomes the <em>default context</em> of your application. When we execute database queries, they run on the default context (by default). If we have multiple databases, we can create more <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/ManagedContext-class.html">ManagedContext</a>s and pass them around to make sure we hit the right database. For now, we can ignore this, just know that it exists.</p>
<h2 id="executing-queries_1">Executing Queries</h2>
<p>Now that we have a context - which can establish a connection to a database, talk to the database and map rows to managed objects - we can execute queries in our <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/RequestController-class.html">RequestController</a>s. In <code>question_controller.dart</code>, replace the code for <code>getAllQuestions</code> (we'll work on <code>getQuestionAtIndex</code> soon):</p>
<div class="codehilite"><pre><span></span><span class="kd">class</span> <span class="nc">QuestionController</span> <span class="kd">extends</span> <span class="n">HttpController</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="n">questions</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;How much wood can a woodchuck chuck?&quot;</span><span class="p">,</span>
    <span class="s2">&quot;What&#39;s the tallest mountain in the world?&quot;</span>
  <span class="p">];</span>

  <span class="err">@</span><span class="n">httpGet</span>
  <span class="n">Future</span><span class="o">&lt;</span><span class="n">Response</span><span class="o">&gt;</span> <span class="n">getAllQuestions</span><span class="p">()</span> <span class="kd">async</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="n">questionQuery</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Query</span><span class="o">&lt;</span><span class="n">Question</span><span class="o">&gt;</span><span class="p">();</span>
    <span class="kd">var</span> <span class="n">databaseQuestions</span> <span class="o">=</span> <span class="kd">await</span> <span class="n">questionQuery</span><span class="p">.</span><span class="n">fetch</span><span class="p">();</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">Response</span><span class="p">.</span><span class="n">ok</span><span class="p">(</span><span class="n">databaseQuestions</span><span class="p">);</span>
  <span class="p">}</span>

<span class="p">...</span>
</pre></div>


<p>When this responder method is executed, it'll create a new <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/Query-class.html">Query&lt;T&gt;</a> for <code>Question</code> (as indicated by the type parameter). A query has a handful of execution methods on it - <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/Query/fetch.html">fetch</a>, <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/Query/fetchOne.html">fetchOne</a>, <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/ManagedSet/insert.html">insert</a>, <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/Query/update.html">update</a>, <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/Query/updateOne.html">updateOne</a> and <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/Query/delete.html">delete</a>. By executing a <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/Query/fetch.html">fetch</a> on a vanilla <code>Query&lt;Question&gt;</code>, this will return a list of <code>Question</code>s, one for each row in the database's question table.</p>
<p>Now, we need an actual database to fetch data from.</p>
<h2 id="configuring-a-database">Configuring a Database</h2>
<p>As we've mentioned a few times, a key facet to Aqueduct is efficient automated testing. The scheme for testing is to create a 'test' database that all of your Aqueduct projects run against. When you run tests against that database, the tests create <em>temporary</em> tables prior to executing. The good news is that the <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/ManagedDataModel-class.html">ManagedDataModel</a> in your application can drive this table creation, so you don't need to do anything special. The tests are run against the current version of the schema defined by your code.</p>
<p>Therefore, on any machine you're going to test on, you need to install PostgreSQL and configure a test database. You'll only need to set this up once on - all Aqueduct project tests run against the same database.</p>
<p>On macOS, the best way to do this locally is download <a href="http://postgresapp.com">Postgres.app</a>. This has a self-contained instance of Postgres that you start by opening up the application itself. Download this application and run it.</p>
<p>Once running, run the command <code>aqueduct setup</code> from anywhere. It will give you some additional instructions to follow to make sure everything is OK. It just runs the following SQL:</p>
<div class="codehilite"><pre><span></span><span class="k">create</span> <span class="k">database</span> <span class="n">dart_test</span><span class="p">;</span>
<span class="k">create</span> <span class="k">user</span> <span class="n">dart</span> <span class="k">with</span> <span class="k">createdb</span><span class="p">;</span>
<span class="k">alter</span> <span class="k">user</span> <span class="n">dart</span> <span class="k">with</span> <span class="n">password</span> <span class="s1">&#39;dart&#39;</span><span class="p">;</span>
<span class="k">grant</span> <span class="k">all</span> <span class="k">on</span> <span class="k">database</span> <span class="n">dart_test</span> <span class="k">to</span> <span class="n">dart</span><span class="p">;</span>
</pre></div>


<p>If you are on another operating system or this command fails for your installation of PostgreSQL, you may run the above commands through the <code>psql</code> command-line utility.</p>
<p>You'll notice in your <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/RequestSink-class.html">RequestSink</a>, the configuration parameters for the <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/PostgreSQLPersistentStore-class.html">PostgreSQLPersistentStore</a> match those that you have just added to your local instance of Postgres, so your application will run against that instance. However, if you were to run your code now, the table backing <code>Question</code>s would not exist. When running tests, we need to create a temporary table for <code>Question</code>s before the tests start. Go to the <code>setUp</code> method in <code>question_controller_test.dart</code>, and enter the following code after the application is started:</p>
<div class="codehilite"><pre><span></span>  <span class="n">setUp</span><span class="p">(()</span> <span class="kd">async</span> <span class="p">{</span>
    <span class="kd">await</span> <span class="n">app</span><span class="p">.</span><span class="n">start</span><span class="p">(</span><span class="nl">runOnMainIsolate:</span> <span class="kc">true</span><span class="p">);</span>
    <span class="n">client</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TestClient</span><span class="p">(</span><span class="n">app</span><span class="p">);</span>

    <span class="kd">var</span> <span class="n">ctx</span> <span class="o">=</span> <span class="n">ManagedContext</span><span class="p">.</span><span class="n">defaultContext</span><span class="p">;</span>
    <span class="kd">var</span> <span class="n">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SchemaBuilder</span><span class="p">.</span><span class="n">toSchema</span><span class="p">(</span>
      <span class="n">ctx</span><span class="p">.</span><span class="n">persistentStore</span><span class="p">,</span> <span class="k">new</span> <span class="n">Schema</span><span class="p">.</span><span class="n">fromDataModel</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">dataModel</span><span class="p">),</span> <span class="nl">isTemporary:</span> <span class="kc">true</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="n">cmd</span> <span class="k">in</span> <span class="n">builder</span><span class="p">.</span><span class="n">commands</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">await</span> <span class="n">ctx</span><span class="p">.</span><span class="n">persistentStore</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">});</span>
</pre></div>


<p>After the application is started, we know that it creates a <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/ManagedContext-class.html">ManagedContext</a> in the constructor of <code>QuizRequestSink</code>. The default context can be accessed through <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/ManagedContext/defaultContext.html">ManagedContext.defaultContext</a>. We also know that this context has a <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/ManagedDataModel-class.html">ManagedDataModel</a> containing <code>Question</code>. The class <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/SchemaBuilder-class.html">SchemaBuilder</a> will create a series of SQL commands from the data model, translated by the <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/PostgreSQLPersistentStore-class.html">PostgreSQLPersistentStore</a>. (Note that the <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/DatabaseConnectionConfiguration/isTemporary.html">isTemporary</a> parameter makes all of the tables temporary and therefore they disappear when the database connection in the context's persistent store closes. This prevents changes to the database from leaking into subsequent tests.)</p>
<p>The database connection is automatically closed when the tests complete by the existing <code>tearDown</code> method that stops the application. Note that when the databsae connection is closed, the tables and data in the database created by this test are discarded.</p>
<p>We now need questions in the database (you can run your tests and see the they fail because there are no questions). Let's first seed the database with some questions using an insert query at the end of <code>setUp</code>.</p>
<div class="codehilite"><pre><span></span>  <span class="n">setUp</span><span class="p">(()</span> <span class="kd">async</span> <span class="p">{</span>
    <span class="kd">await</span> <span class="n">app</span><span class="p">.</span><span class="n">start</span><span class="p">(</span><span class="nl">runOnMainIsolate:</span> <span class="kc">true</span><span class="p">);</span>
    <span class="n">client</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TestClient</span><span class="p">(</span><span class="n">app</span><span class="p">);</span>

    <span class="kd">var</span> <span class="n">ctx</span> <span class="o">=</span> <span class="n">ManagedContext</span><span class="p">.</span><span class="n">defaultContext</span><span class="p">;</span>
    <span class="kd">var</span> <span class="n">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SchemaBuilder</span><span class="p">.</span><span class="n">toSchema</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">persistentStore</span><span class="p">,</span> <span class="k">new</span> <span class="n">Schema</span><span class="p">.</span><span class="n">fromDataModel</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">dataModel</span><span class="p">),</span> <span class="nl">isTemporary:</span> <span class="kc">true</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="n">cmd</span> <span class="k">in</span> <span class="n">builder</span><span class="p">.</span><span class="n">commands</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">await</span> <span class="n">ctx</span><span class="p">.</span><span class="n">persistentStore</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="n">questions</span> <span class="o">=</span> <span class="p">[</span>
      <span class="s2">&quot;How much wood can a woodchuck chuck?&quot;</span><span class="p">,</span>
      <span class="s2">&quot;What&#39;s the tallest mountain in the world?&quot;</span>
    <span class="p">];</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="n">question</span> <span class="k">in</span> <span class="n">questions</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="n">insertQuery</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Query</span><span class="o">&lt;</span><span class="n">Question</span><span class="o">&gt;</span><span class="p">()</span>
        <span class="p">..</span><span class="n">values</span><span class="p">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">question</span><span class="p">;</span>
      <span class="kd">await</span> <span class="n">insertQuery</span><span class="p">.</span><span class="n">insert</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">});</span>
</pre></div>


<p>Now, this is also a lesson in insert queries. <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/Query-class.html">Query&lt;T&gt;</a> has a property named <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/Query/values.html">values</a>, an instance of the type being queried. In this case, <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/Query/values.html">values</a> is a <code>Question</code> because the query is created as <code>Query&lt;Question&gt;</code>. When the <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/Query-class.html">Query&lt;T&gt;</a> is inserted, all of the values that have been set on <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/Query/values.html">values</a> property are inserted into the database. (If you don't set a value, it isn't sent in the insert query at all. A <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/Query-class.html">Query&lt;T&gt;</a> does not send <code>null</code> unless you explicitly set a property to <code>null</code>.)</p>
<p>In our seeded test database, there will be two questions. If you re-run the tests, the first one should pa... wait, no it fails. The test results says this:</p>
<div class="codehilite"><pre><span></span><span class="n">Expected</span><span class="o">:</span>
  <span class="n">Status</span> <span class="n">Code</span><span class="o">:</span> <span class="mi">200</span>
  <span class="n">Body</span><span class="o">:</span> <span class="n">every</span> <span class="n">element</span><span class="o">(</span><span class="n">a</span> <span class="n">string</span> <span class="n">ending</span> <span class="k">with</span> <span class="s1">&#39;?&#39;</span><span class="o">)</span>
  <span class="n">Actual</span><span class="o">:</span> <span class="n">TestResponse</span><span class="o">:&lt;</span>
  <span class="n">Status</span> <span class="n">Code</span><span class="o">:</span> <span class="mi">200</span>
  <span class="n">Headers</span><span class="o">:</span> <span class="n">transfer</span><span class="o">-</span><span class="n">encoding</span><span class="o">:</span> <span class="n">chunked</span>
       <span class="n">content</span><span class="o">-</span><span class="n">encoding</span><span class="o">:</span> <span class="n">gzip</span>
       <span class="n">x</span><span class="o">-</span><span class="n">frame</span><span class="o">-</span><span class="n">options</span><span class="o">:</span> <span class="n">SAMEORIGIN</span>
       <span class="n">content</span><span class="o">-</span><span class="n">type</span><span class="o">:</span> <span class="n">application</span><span class="o">/</span><span class="n">json</span><span class="o">;</span> <span class="n">charset</span><span class="o">=</span><span class="n">utf</span><span class="o">-</span><span class="mi">8</span>
       <span class="n">x</span><span class="o">-</span><span class="n">xss</span><span class="o">-</span><span class="n">protection</span><span class="o">:</span> <span class="mi">1</span><span class="o">;</span> <span class="n">mode</span><span class="o">=</span><span class="n">block</span>
       <span class="n">x</span><span class="o">-</span><span class="n">content</span><span class="o">-</span><span class="n">type</span><span class="o">-</span><span class="n">options</span><span class="o">:</span> <span class="n">nosniff</span>
       <span class="n">server</span><span class="o">:</span> <span class="n">aqueduct</span><span class="o">/</span><span class="mi">1</span>
  <span class="n">Body</span><span class="o">:</span> <span class="o">[{</span><span class="s2">&quot;index&quot;</span><span class="o">:</span><span class="mi">1</span><span class="o">,</span><span class="s2">&quot;description&quot;</span><span class="o">:</span><span class="s2">&quot;How much wood can a woodchuck chuck?&quot;</span><span class="o">},{</span><span class="s2">&quot;index&quot;</span><span class="o">:</span><span class="mi">2</span><span class="o">,</span><span class="s2">&quot;description&quot;</span><span class="o">:</span><span class="s2">&quot;What&#39;s the tallest mountain in the world?&quot;</span><span class="o">}]&gt;</span>
</pre></div>


<p>When a <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct.test/hasResponse.html">hasResponse</a> matcher fails, it prints out what you expected and what the <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct.test/TestResponse-class.html">TestResponse</a> actually was. The expectation was that every element is a string ending with '?'. Instead, the bottom of the test result says that the body is actually a list of maps, for which there is a index and a description. This is the list of JSON-encoded <code>Question</code> objects, and they are obviously not <code>String</code>s like they previously were.</p>
<p>This is because a <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/ManagedObject-class.html">ManagedObject</a> like <code>Question</code> is serialized into a <code>Map&lt;String, dynamic&gt;</code> when returned in a <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/Response-class.html">Response</a>. Each key in the map is a property of the managed object. Since <code>Question</code> declares two properties - <code>index</code> and <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/APIHeader/description.html">description</a> - each question in the response body JSON is a map of those two values. Let's update this test to reflect that change:</p>
<div class="codehilite"><pre><span></span>  <span class="n">test</span><span class="p">(</span><span class="s2">&quot;/questions returns list of questions&quot;</span><span class="p">,</span> <span class="p">()</span> <span class="kd">async</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="n">response</span> <span class="o">=</span> <span class="kd">await</span> <span class="n">client</span><span class="p">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;/questions&quot;</span><span class="p">).</span><span class="kd">get</span><span class="p">();</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">hasResponse</span><span class="p">(</span><span class="m">200</span><span class="p">,</span> <span class="n">everyElement</span><span class="p">({</span>
        <span class="s2">&quot;index&quot;</span> <span class="o">:</span> <span class="n">greaterThan</span><span class="p">(</span><span class="m">0</span><span class="p">),</span>
        <span class="s2">&quot;description&quot;</span> <span class="o">:</span> <span class="n">endsWith</span><span class="p">(</span><span class="s2">&quot;?&quot;</span><span class="p">)</span>
    <span class="p">})));</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">decodedBody</span><span class="p">,</span> <span class="n">hasLength</span><span class="p">(</span><span class="n">greaterThan</span><span class="p">(</span><span class="m">0</span><span class="p">)));</span>
  <span class="p">});</span>
</pre></div>


<p>Now, the expectation is that every element in the response body is a <code>Map</code>, for which it has an <code>index</code> greater than or equal to <code>0</code> and and a <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/APIHeader/description.html">description</a> that ends with <code>?</code>. Run these tests again and the tests will pass.</p>
<p>Now, our <code>QuestionController</code> reads from a database when fetching all questions through the <code>/questions</code> endpoint. However, it is still reading from the list of static questions when fetching a single question with <code>/questions/:id</code>.</p>
<p>Modify <code>getQuestionAtIndex</code> in <code>question_controller.dart</code> to fetch a single question from the database. You may also delete the property <code>questions</code> from <code>QuestionController</code>.</p>
<div class="codehilite"><pre><span></span>  <span class="err">@</span><span class="n">httpGet</span>
  <span class="n">Future</span><span class="o">&lt;</span><span class="n">Response</span><span class="o">&gt;</span> <span class="n">getQuestionAtIndex</span><span class="p">(</span><span class="err">@</span><span class="n">HTTPPath</span><span class="p">(</span><span class="s2">&quot;index&quot;</span><span class="p">)</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span> <span class="kd">async</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="n">questionQuery</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Query</span><span class="o">&lt;</span><span class="n">Question</span><span class="o">&gt;</span><span class="p">()</span>
      <span class="p">..</span><span class="n">where</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">whereEqualTo</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>    

    <span class="kd">var</span> <span class="n">question</span> <span class="o">=</span> <span class="kd">await</span> <span class="n">questionQuery</span><span class="p">.</span><span class="n">fetchOne</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">question</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="n">Response</span><span class="p">.</span><span class="n">notFound</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">Response</span><span class="p">.</span><span class="n">ok</span><span class="p">(</span><span class="n">question</span><span class="p">);</span>
  <span class="p">}</span>
</pre></div>


<p>In this query, a 'where' is being applied to the query. The <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/Query/where.html">Query.where</a> property allows you to restrict the results returned from a query to those that match the conditions applied to it. <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/Query/where.html">Query.where</a> is also an instance of <code>Question</code>, like <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/Query/values.html">values</a>, so its properties like <code>index</code> are accessible. When setting a property of <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/Query/where.html">Query.where</a>, you must use a <em>matcher</em>. There are many available matchers and all of them begin with the word 'where'. This particular query only fetches questions where the index is equal to the argument <code>index</code>. (Check the <a href="https://www.dartdocs.org/documentation/aqueduct/latest">Aqueduct API reference</a> to see all of the matchers.)</p>
<p>Now, we must update the second test in <code>question_controller_test.dart</code> now that this endpoint is returning a JSON object that represents a question:</p>
<div class="codehilite"><pre><span></span>  <span class="n">test</span><span class="p">(</span><span class="s2">&quot;/questions/index returns a single question&quot;</span><span class="p">,</span> <span class="p">()</span> <span class="kd">async</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="n">response</span> <span class="o">=</span> <span class="kd">await</span> <span class="n">client</span><span class="p">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;/questions/1&quot;</span><span class="p">).</span><span class="kd">get</span><span class="p">();</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">hasResponse</span><span class="p">(</span><span class="m">200</span><span class="p">,</span> <span class="p">{</span>
        <span class="s2">&quot;index&quot;</span> <span class="o">:</span> <span class="n">greaterThanOrEqualTo</span><span class="p">(</span><span class="m">0</span><span class="p">),</span>
        <span class="s2">&quot;description&quot;</span> <span class="o">:</span> <span class="n">endsWith</span><span class="p">(</span><span class="s2">&quot;?&quot;</span><span class="p">)</span>
    <span class="p">}));</span>
  <span class="p">});</span>
</pre></div>


<p>That's fetch and insert. Delete works the same way - you specify <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/ManagedSet/where.html">where</a> values and invoke <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/Query/delete.html">delete</a> on the query. If you want to update database rows, you specify both <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/Query/values.html">values</a> and <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/ManagedSet/where.html">where</a>.</p>
<h2 id="the-more-you-know-query-parameters-and-http-headers">The more you know: Query Parameters and HTTP Headers</h2>
<p>You can specify that a <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/HTTPController-class.html">HTTPController</a> responder method extract HTTP query parameters and headers and supply them as arguments to the method. We'll allow the <code>getAllQuestions</code> method to take a query parameter named <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/ManagedSet/contains.html">contains</a>. If this query parameter is part of the request, we'll filter the questions on whether or not that question contains some substring. In <code>question_controller.dart</code>, update this method:</p>
<div class="codehilite"><pre><span></span>  <span class="err">@</span><span class="n">httpGet</span>
  <span class="n">Future</span><span class="o">&lt;</span><span class="n">Response</span><span class="o">&gt;</span> <span class="n">getAllQuestions</span><span class="p">({</span><span class="err">@</span><span class="n">HTTPQuery</span><span class="p">(</span><span class="s2">&quot;contains&quot;</span><span class="p">)</span> <span class="kt">String</span> <span class="nl">containsSubstring:</span> <span class="kc">null</span><span class="p">})</span> <span class="kd">async</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="n">questionQuery</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Query</span><span class="o">&lt;</span><span class="n">Question</span><span class="o">&gt;</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">containsSubstring</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">questionQuery</span><span class="p">.</span><span class="n">where</span><span class="p">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">whereContainsString</span><span class="p">(</span><span class="n">containsSubstring</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="n">questions</span> <span class="o">=</span> <span class="kd">await</span> <span class="n">questionQuery</span><span class="p">.</span><span class="n">fetch</span><span class="p">();</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">Response</span><span class="p">.</span><span class="n">ok</span><span class="p">(</span><span class="n">questions</span><span class="p">);</span>
  <span class="p">}</span>
</pre></div>


<p>If an HTTP request has a <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/ManagedSet/contains.html">contains</a> query parameter, that value will be passed as the <code>containsSubstring</code> parameter. As you can see, you may name the parameter whatever you like, it doesn't have to match the name of query parameter. Also, note that we first check <code>containsSubstring</code> to make sure it is not-null. If we simply assigned <code>null</code> to <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/APIHeader/description.html">description</a>, we'd be creating a matcher that checked to see if the <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/APIHeader/description.html">description</a> <em>contained</em> <code>null</code>.</p>
<p>Using HTTP header values as parameters is accomplished in the same way, except using the <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/HTTPHeader-class.html">HTTPHeader</a> metadata. Query parameters are case sensitive, where header parameters are not.</p>
<p>Then, add a new test in <code>question_controller_test.dart</code>:</p>
<div class="codehilite"><pre><span></span>  <span class="n">test</span><span class="p">(</span><span class="s2">&quot;/questions returns list of questions filtered by contains&quot;</span><span class="p">,</span> <span class="p">()</span> <span class="kd">async</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="n">response</span> <span class="o">=</span> <span class="kd">await</span> <span class="n">client</span><span class="p">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;/questions?contains=mountain&quot;</span><span class="p">).</span><span class="kd">get</span><span class="p">();</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">hasResponse</span><span class="p">(</span><span class="m">200</span><span class="p">,</span> <span class="p">[{</span>
        <span class="s2">&quot;index&quot;</span> <span class="o">:</span> <span class="n">greaterThanOrEqualTo</span><span class="p">(</span><span class="m">0</span><span class="p">),</span>
        <span class="s2">&quot;description&quot;</span> <span class="o">:</span> <span class="s2">&quot;What&#39;s the tallest mountain in the world?&quot;</span>
    <span class="p">}]));</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">decodedBody</span><span class="p">,</span> <span class="n">hasLength</span><span class="p">(</span><span class="m">1</span><span class="p">));</span>
  <span class="p">});</span>
</pre></div>


<p>This test will pass, along with the rest of them. It's important to note that GET <code>/questions</code> without a <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/ManagedSet/contains.html">contains</a> query still yields the correct results. That is because the <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/HTTPQuery-class.html">HTTPQuery</a> argument was declared in the optional parameters portion of the responder method. If the parameter were in the required, positional set of parameters and the query string was not included, this request would respond with a 400. (The same positional vs. optional behavior is true of <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/HTTPHeader-class.html">HTTPHeader</a>s as well.) For example, if we wanted to make a 'X-Client-ID' header that had to be included on this request, we'd do the following:</p>
<div class="codehilite"><pre><span></span>  <span class="err">@</span><span class="n">httpGet</span>
  <span class="n">Future</span><span class="o">&lt;</span><span class="n">Response</span><span class="o">&gt;</span> <span class="n">getAllQuestions</span><span class="p">(</span>
    <span class="err">@</span><span class="n">HTTPHeader</span><span class="p">(</span><span class="s2">&quot;X-Client-ID&quot;</span><span class="p">)</span> <span class="kt">int</span> <span class="n">clientID</span><span class="p">,</span>
    <span class="p">{</span><span class="err">@</span><span class="n">HTTPQuery</span><span class="p">(</span><span class="s2">&quot;contains&quot;</span><span class="p">)</span> <span class="kt">String</span> <span class="n">containsSubstring</span> <span class="o">=</span> <span class="kc">null</span><span class="p">}</span>
  <span class="p">)</span> <span class="kd">async</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">clientID</span> <span class="o">!=</span> <span class="m">12345</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="n">Response</span><span class="p">.</span><span class="n">unauthorized</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="n">questionQuery</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Query</span><span class="o">&lt;</span><span class="n">Question</span><span class="o">&gt;</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">containsSubstring</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">questionQuery</span><span class="p">.</span><span class="n">where</span><span class="p">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">whereContainsString</span><span class="p">(</span><span class="n">containsSubstring</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="n">questions</span> <span class="o">=</span> <span class="kd">await</span> <span class="n">questionQuery</span><span class="p">.</span><span class="n">fetch</span><span class="p">();</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">Response</span><span class="p">.</span><span class="n">ok</span><span class="p">(</span><span class="n">questions</span><span class="p">);</span>
  <span class="p">}</span>
</pre></div>


<p>Note that in this case, the <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/APIConfiguration/clientID.html">clientID</a> will be parsed as an integer before being sent as an argument to <code>getAllQuestions</code>. If the value cannot be parsed as an integer or is omitted, a 400 status code will be returned before your responder method gets called.</p>
<p>Specifying query and header parameters in a responder method is a good way to make your code more intentional and avoid boilerplate parsing code. Additionally, Aqueduct is able to generate documentation from method signatures - by specifying these types of parameters, the documentation generator can add that information to the documentation.</p>
<h2 id="next-relationships-and-joins"><a href="../model-relationships-and-joins/">Next: Relationships and Joins</a></h2>
              
              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../writing-tests/" title="2. Writing Tests" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                2. Writing Tests
              </span>
            </div>
          </a>
        
        
          <a href="../model-relationships-and-joins/" title="4. Advanced Database Queries" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                4. Advanced Database Queries
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Built by stable|kernel
          </div>
        
        powered by
        <a href="http://www.mkdocs.org" title="MkDocs">MkDocs</a>
        and
        <a href="http://squidfunk.github.io/mkdocs-material/" title="Material for MkDocs">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application-30ac6a1727.js"></script>
      <script>app.initialize({url:{base:"../.."}})</script>
      
    
    
      
      <script>!function(e,t,a,n,o,c,i){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,c=t.createElement(a),i=t.getElementsByTagName(a)[0],c.async=1,c.src=n,i.parentNode.insertBefore(c,i)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-41269877-2","aqueduct.io"),ga("set","anonymizeIp",!0),ga("send","pageview");var links=document.getElementsByTagName("a");Array.prototype.map.call(links,function(e){e.host!=document.location.host&&e.addEventListener("click",function(){var t=e.getAttribute("data-md-action")||"follow";ga("send","event","outbound",t,e.href)})});var query=document.forms.search.query;query.addEventListener("blur",function(){if(this.value){var e=document.location.pathname;ga("send","pageview",e+"?q="+this.value)}})</script>
      
    
  </body>
</html>