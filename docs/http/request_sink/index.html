
<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="Documentation for Aqueduct, a Dart server-side framework.">
      
      
      
      
        <link rel="shortcut icon" href="../../assets/images/favicon.png">
      
      <meta name="generator" content="mkdocs-0.16.3, mkdocs-material-1.9.0">
    
    
      
        <title>Initialization and the RequestSink - Aqueduct</title>
      
    
    
      <script src="../../assets/javascripts/modernizr-e826f8942a.js"></script>
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application-0a3554af36.css">
      
    
    
      
        
        
        
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
      <link rel="stylesheet" href="../../style/css/override.css">
    
    
  </head>
  
  
  
  
    <body>
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="search">
    <label class="md-overlay" data-md-component="overlay" for="drawer"></label>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <a href="../.." title="Aqueduct" class="md-icon md-icon--home md-header-nav__button">
          </a>
        
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <span class="md-flex__ellipsis md-header-nav__title">
          
            
              
                <span class="md-header-nav__parent">
                  Serving HTTP Requests
                </span>
              
            
            Initialization and the RequestSink
          
        </span>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="search"></label>
  <div class="md-search__inner">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" required placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query">
      <label class="md-icon md-search__icon" for="search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset">&#xE5CD;</button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result" data-md-lang-search="" data-md-lang-tokenizer="[\s\-]+">
          <div class="md-search-result__meta" data-md-lang-result-none="No matching documents" data-md-lang-result-one="1 matching document" data-md-lang-result-other="# matching documents">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  


  <a href="https://github.com/stablekernel/aqueduct" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="drawer">
    
      <i class="md-icon md-icon--home md-nav__button"></i>
    
    Aqueduct
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/stablekernel/aqueduct" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../getting_started/" title="Getting Started" class="md-nav__link">
      Getting Started
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../tour/" title="Tour" class="md-nav__link">
      Tour
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../intellij/" title="IntelliJ IDEA Templates" class="md-nav__link">
      IntelliJ IDEA Templates
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      Tutorial
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        Tutorial
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../tut/getting-started/" title="1. Getting Started" class="md-nav__link">
      1. Getting Started
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../tut/writing-tests/" title="2. Writing Tests" class="md-nav__link">
      2. Writing Tests
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../tut/executing-queries/" title="3. Executing Database Queries" class="md-nav__link">
      3. Executing Database Queries
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../tut/model-relationships-and-joins/" title="4. Advanced Database Queries" class="md-nav__link">
      4. Advanced Database Queries
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../tut/deploying-and-other-fun-things/" title="5. Deploying" class="md-nav__link">
      5. Deploying
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6" checked>
    
    <label class="md-nav__link" for="nav-6">
      Serving HTTP Requests
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        Serving HTTP Requests
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../overview/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../structure/" title="Application Structure" class="md-nav__link">
      Application Structure
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../request_and_response/" title="Request and Response Objects" class="md-nav__link">
      Request and Response Objects
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../request_controller/" title="Handling Requests: Fundamentals" class="md-nav__link">
      Handling Requests: Fundamentals
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../routing/" title="Routing" class="md-nav__link">
      Routing
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="toc">
        Initialization and the RequestSink
      </label>
    
    <a href="./" title="Initialization and the RequestSink" class="md-nav__link md-nav__link--active">
      Initialization and the RequestSink
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#subclassing-requestsink" title="Subclassing RequestSink" class="md-nav__link">
    Subclassing RequestSink
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#use-requestsinkinitializeapplication-for-one-time-initialization" title="Use RequestSink.initializeApplication for One-Time Initialization" class="md-nav__link">
    Use RequestSink.initializeApplication for One-Time Initialization
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-requestsinks-constructor-to-initialize-service-and-isolate-specific-configurations" title="Use RequestSink's Constructor to Initialize Service and Isolate-Specific Configurations" class="md-nav__link">
    Use RequestSink's Constructor to Initialize Service and Isolate-Specific Configurations
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#setting-up-routes-in-setuprouter" title="Setting up Routes in setupRouter" class="md-nav__link">
    Setting up Routes in setupRouter
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#perform-asynchronous-initialization-with-willopen" title="Perform Asynchronous Initialization with willOpen" class="md-nav__link">
    Perform Asynchronous Initialization with willOpen
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#start-receiving-requests" title="Start Receiving Requests" class="md-nav__link">
    Start Receiving Requests
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lazy-services" title="Lazy Services" class="md-nav__link">
    Lazy Services
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#multi-threaded-aqueduct-applications" title="Multi-threaded Aqueduct Applications" class="md-nav__link">
    Multi-threaded Aqueduct Applications
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-application-object" title="The Application Object" class="md-nav__link">
    The Application Object
  </a>
  
</li>
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../http_controller/" title="Handling Requests: HTTPController" class="md-nav__link">
      Handling Requests: HTTPController
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../configure/" title="Configuration" class="md-nav__link">
      Configuration
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../serving_files/" title="Serving Files and Caching" class="md-nav__link">
      Serving Files and Caching
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../websockets/" title="Websockets" class="md-nav__link">
      Websockets
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../threading/" title="Multi-threading" class="md-nav__link">
      Multi-threading
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7">
    
    <label class="md-nav__link" for="nav-7">
      Databases and ORM
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        Databases and ORM
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../db/overview/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../db/connecting/" title="Connecting to a Database" class="md-nav__link">
      Connecting to a Database
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../db/modeling_data/" title="Modeling Data" class="md-nav__link">
      Modeling Data
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../db/serialization/" title="Storage, Serialization and Deserialization" class="md-nav__link">
      Storage, Serialization and Deserialization
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../db/executing_queries/" title="Executing Queries" class="md-nav__link">
      Executing Queries
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../db/advanced_queries/" title="Advanced Queries" class="md-nav__link">
      Advanced Queries
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../db/validations/" title="Validations" class="md-nav__link">
      Validations
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../db/db_tools/" title="Migration and Tooling" class="md-nav__link">
      Migration and Tooling
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8" type="checkbox" id="nav-8">
    
    <label class="md-nav__link" for="nav-8">
      Authorization and OAuth 2.0
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-8">
        Authorization and OAuth 2.0
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../auth/overview/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../auth/server/" title="Setting up Authorization" class="md-nav__link">
      Setting up Authorization
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../auth/authorizer/" title="Protecting Routes" class="md-nav__link">
      Protecting Routes
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../auth/controllers/" title="Issuing Access Tokens" class="md-nav__link">
      Issuing Access Tokens
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../auth/cli/" title="Managing OAuth 2.0 Clients" class="md-nav__link">
      Managing OAuth 2.0 Clients
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../auth/auth_scopes/" title="OAuth 2.0 Scoping" class="md-nav__link">
      OAuth 2.0 Scoping
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../auth/what_is_oauth/" title="What is OAuth 2.0?" class="md-nav__link">
      What is OAuth 2.0?
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-9" type="checkbox" id="nav-9">
    
    <label class="md-nav__link" for="nav-9">
      Development and Testing
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-9">
        Development and Testing
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../testing/overview/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../testing/database/" title="Using a Local Database" class="md-nav__link">
      Using a Local Database
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../testing/debugger/" title="Using the Debugger" class="md-nav__link">
      Using the Debugger
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../testing/best_practices/" title="Development Best Practices" class="md-nav__link">
      Development Best Practices
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../testing/clients/" title="Developing Client Applications" class="md-nav__link">
      Developing Client Applications
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../testing/tests/" title="Writing Tests" class="md-nav__link">
      Writing Tests
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../testing/mock/" title="Mocking Services" class="md-nav__link">
      Mocking Services
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-10" type="checkbox" id="nav-10">
    
    <label class="md-nav__link" for="nav-10">
      Deployment
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-10">
        Deployment
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../deploy/overview/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../deploy/deploy_local/" title="Deploy Locally" class="md-nav__link">
      Deploy Locally
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../deploy/deploy_heroku/" title="Deploy on Heroku" class="md-nav__link">
      Deploy on Heroku
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../deploy/deploy_aws/" title="Deploy on AWS" class="md-nav__link">
      Deploy on AWS
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../deploy/script/" title="Deploying without aqueduct serve" class="md-nav__link">
      Deploying without aqueduct serve
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-11" type="checkbox" id="nav-11">
    
    <label class="md-nav__link" for="nav-11">
      Command-line Tooling
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-11">
        Command-line Tooling
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../cli/overview/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cli/create/" title="Creating Applications" class="md-nav__link">
      Creating Applications
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cli/running/" title="Running Applications" class="md-nav__link">
      Running Applications
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cli/document/" title="Generating an OpenAPI/Swagger Specification" class="md-nav__link">
      Generating an OpenAPI/Swagger Specification
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cli/setup/" title="Other Tools" class="md-nav__link">
      Other Tools
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-12" type="checkbox" id="nav-12">
    
    <label class="md-nav__link" for="nav-12">
      Snippets
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-12">
        Snippets
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../snippets/overview/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../snippets/http/" title="HTTP" class="md-nav__link">
      HTTP
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../snippets/orm/" title="ORM" class="md-nav__link">
      ORM
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../snippets/auth/" title="Authentication and Authorization" class="md-nav__link">
      Authentication and Authorization
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../snippets/test/" title="Testing" class="md-nav__link">
      Testing
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#subclassing-requestsink" title="Subclassing RequestSink" class="md-nav__link">
    Subclassing RequestSink
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#use-requestsinkinitializeapplication-for-one-time-initialization" title="Use RequestSink.initializeApplication for One-Time Initialization" class="md-nav__link">
    Use RequestSink.initializeApplication for One-Time Initialization
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-requestsinks-constructor-to-initialize-service-and-isolate-specific-configurations" title="Use RequestSink's Constructor to Initialize Service and Isolate-Specific Configurations" class="md-nav__link">
    Use RequestSink's Constructor to Initialize Service and Isolate-Specific Configurations
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#setting-up-routes-in-setuprouter" title="Setting up Routes in setupRouter" class="md-nav__link">
    Setting up Routes in setupRouter
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#perform-asynchronous-initialization-with-willopen" title="Perform Asynchronous Initialization with willOpen" class="md-nav__link">
    Perform Asynchronous Initialization with willOpen
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#start-receiving-requests" title="Start Receiving Requests" class="md-nav__link">
    Start Receiving Requests
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lazy-services" title="Lazy Services" class="md-nav__link">
    Lazy Services
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#multi-threaded-aqueduct-applications" title="Multi-threaded Aqueduct Applications" class="md-nav__link">
    Multi-threaded Aqueduct Applications
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-application-object" title="The Application Object" class="md-nav__link">
    The Application Object
  </a>
  
</li>
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/stablekernel/aqueduct/edit/master/docs/http/request_sink.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="application-initialization-and-the-requestsink">Application Initialization and the RequestSink</h1>
<p>The only requirement of an Aqueduct application is that it has exactly one <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/RequestSink-class.html">RequestSink</a> subclass. This subclass handles the initialization of an application, including setting up routes, authorization and database connections.</p>
<p>A <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/RequestSink-class.html">RequestSink</a> subclass is declared in its own file named <code>lib/&lt;application_name&gt;_request_sink.dart</code>, which is exported from the application library file. (For example if the application is named <code>wildfire</code>, the application library file is <code>lib/wildfire.dart</code>.)</p>
<div class="codehilite"><pre><span></span>wildfire/
  lib/
    wildfire.dart
    wildfire_request_sink.dart
    controllers/
      user_controller.dart      
    ...
</pre></div>


<p>Applications are run with the command line tool <code>aqueduct serve</code>. This tool create multiple <code>Isolate</code>s (a thread managed by the VM) and creates an instance of the <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/RequestSink-class.html">RequestSink</a> for each. Therefore, the channel of <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/RequestController-class.html">RequestController</a>s created by the <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/RequestSink-class.html">RequestSink</a> is replicated for each isolate. Requests are divvied up among each isolate to maximize CPU and resource usage.</p>
<h2 id="subclassing-requestsink">Subclassing RequestSink</h2>
<p>The responsibility of a <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/RequestSink-class.html">RequestSink</a> is to set up routes and initialize services it will use to fulfill requests. There are five initialization methods in <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/RequestSink-class.html">RequestSink</a>, each with its own purpose. The methods and the order they are executed in are as follows:</p>
<ol>
<li><a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/RequestSink/initializeApplication.html">RequestSink.initializeApplication</a>: this <em>static</em> method is called once at the very beginning of an application's startup, before any instances of <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/RequestSink-class.html">RequestSink</a> are created.</li>
<li>An instance of <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/RequestSink-class.html">RequestSink</a> is created with its default constructor.</li>
<li>The method <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/RequestSink/setupRouter.html">setupRouter</a> is invoked on the <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/RequestSink-class.html">RequestSink</a> instance; initialized properties from the constructor are injected into controllers created here.</li>
<li>The method <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/RequestSink/willOpen.html">willOpen</a> is invoked on the <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/RequestSink-class.html">RequestSink</a> instance.</li>
<li>The method <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/ApplicationServer/didOpen.html">didOpen</a> is invoked on the <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/RequestSink-class.html">RequestSink</a> instance.</li>
</ol>
<p>Only <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/RequestSink/setupRouter.html">setupRouter</a> is required, but it is extremely common to provide a constructor and implement <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/RequestSink/initializeApplication.html">RequestSink.initializeApplication</a>. It is rare to use <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/RequestSink/willOpen.html">willOpen</a> and rarer still to use <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/ApplicationServer/didOpen.html">didOpen</a>.</p>
<p>Aqueduct applications will create more than one instance of <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/RequestSink-class.html">RequestSink</a> and repeat steps 2-5 for each instance. See a later section on multi-threading in Aqueduct applications.</p>
<p>The usage and details for each of these initialization methods is detailed in the following sections.</p>
<h3 id="use-requestsinkinitializeapplication-for-one-time-initialization">Use RequestSink.initializeApplication for One-Time Initialization</h3>
<p>Since many instances of <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/RequestSink-class.html">RequestSink</a> will be created in an Aqueduct application, its instance methods and constructor will be called multiple times. An Aqueduct application may often have to execute one-time startup tasks that must not occur more than once. For this purpose, you may implement a <em>static</em> method with the following name and signature in an application's <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/RequestSink-class.html">RequestSink</a>:</p>
<div class="codehilite"><pre><span></span><span class="kd">static</span> <span class="n">Future</span> <span class="n">initializeApplication</span><span class="p">(</span><span class="n">ApplicationConfiguration</span> <span class="n">config</span><span class="p">)</span> <span class="kd">async</span> <span class="p">{</span>
  <span class="p">...</span> <span class="k">do</span> <span class="n">one</span> <span class="n">time</span> <span class="n">setup</span> <span class="p">...</span>
<span class="p">}</span>
</pre></div>


<p>A common use of this method is to set up services that will be shared across isolates or unique persistent connections to remote services. This method can modify <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/ApplicationConfiguration-class.html">ApplicationConfiguration</a> prior to <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/RequestSink-class.html">RequestSink</a> instances being created. This allows services allocated during this one-time setup method can be accessible by each <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/RequestSink-class.html">RequestSink</a> instance.</p>
<p>For example:</p>
<div class="codehilite"><pre><span></span><span class="kd">static</span> <span class="n">Future</span> <span class="n">initializeApplication</span><span class="p">(</span><span class="n">ApplicationConfiguration</span> <span class="n">config</span><span class="p">)</span> <span class="kd">async</span> <span class="p">{</span>        
  <span class="n">config</span><span class="p">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;special item&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;xyz&quot;</span><span class="p">;</span>
<span class="p">}</span>  

<span class="n">RequestSink</span><span class="p">(</span><span class="n">ApplicationConfiguration</span> <span class="n">config</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="n">parsedConfigValues</span> <span class="o">=</span> <span class="n">config</span><span class="p">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;special item&quot;</span><span class="p">];</span> <span class="c1">// == xyz</span>
<span class="p">}</span>
</pre></div>


<p>In a more complex example, Aqueduct applications that use <a href="https://pub.dartlang.org/packages/scribe">scribe</a> will implement <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/RequestSink/initializeApplication.html">initializeApplication</a> to optimize logging. <code>scribe</code> works by spawning a new isolate that writes log statements to disk or the console. Aqueduct isolates send their log messages to the logging isolate so that they can move on to more important things. The logging isolate is spawned in <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/RequestSink/initializeApplication.html">initializeApplication</a> and a reference is stored in <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/ApplicationConfiguration-class.html">ApplicationConfiguration</a>. Each <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/RequestSink-class.html">RequestSink</a> grabs the reference so that it can send messages to the logging isolate later.</p>
<p>It is important to note the behavior of isolates as it relates to Aqueduct and the initialization process. Each isolate has its own heap. <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/RequestSink/initializeApplication.html">initializeApplication</a> is executed in the main isolate, whereas each <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/RequestSink-class.html">RequestSink</a> is instantiated in its own isolate. This means that any values stored in <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/ApplicationConfiguration-class.html">ApplicationConfiguration</a> must be safe to pass across isolates - i.e., they can't contain references to closures.</p>
<p>Additionally, any static or global variables that are set in the main isolate <em>will not be set</em> in other isolates. Configuration types like <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/HTTPCodecRepository-class.html">HTTPCodecRepository</a> do not share values across isolates. Therefore, they must be set up in the <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/RequestSink-class.html">RequestSink</a> constructor.</p>
<div class="codehilite"><pre><span></span><span class="c1">/// Do not do this!</span>
<span class="kd">static</span> <span class="n">Future</span> <span class="n">initializeApplication</span><span class="p">(</span><span class="n">ApplicationConfiguration</span> <span class="n">config</span><span class="p">)</span> <span class="kd">async</span> <span class="p">{</span>        
  <span class="n">HTTPCodecRepository</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="k">new</span> <span class="n">ContentType</span><span class="p">(</span><span class="s2">&quot;application&quot;</span><span class="p">,</span> <span class="s2">&quot;xml&quot;</span><span class="p">),</span> <span class="k">new</span> <span class="n">XMLCodec</span><span class="p">());</span>
<span class="p">}</span>  
</pre></div>


<p>Also, because static methods cannot be overridden in Dart, it is important that you ensure the name and signature of <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/RequestSink/initializeApplication.html">initializeApplication</a> exactly matches what is shown in these code samples. The analyzer can't help you here, unfortunately.</p>
<h3 id="use-requestsinks-constructor-to-initialize-service-and-isolate-specific-configurations">Use RequestSink's Constructor to Initialize Service and Isolate-Specific Configurations</h3>
<p>A service, in this context, is something your application will use to fulfill requests. A database connection is an example of a service. Services should be created the constructor of a <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/RequestSink-class.html">RequestSink</a> and stored as properties.</p>
<p>The constructor of a <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/RequestSink-class.html">RequestSink</a> must be unnamed and take a single argument of type <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/ApplicationConfiguration-class.html">ApplicationConfiguration</a>. This instance of <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/ApplicationConfiguration-class.html">ApplicationConfiguration</a> will have the same values as the instance in the previous initialization step (<a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/RequestSink/initializeApplication.html">initializeApplication</a>). The configuration contains a path to the configuration file that the application was started with (this defaults to <code>config.yaml</code>). This file often contains values that set up things like database connections:</p>
<p>The values in <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/ApplicationConfiguration-class.html">ApplicationConfiguration</a> often contain the details for the services that should be created - like database connection information. Here is an example:</p>
<div class="codehilite"><pre><span></span><span class="kd">class</span> <span class="nc">MySink</span> <span class="kd">extends</span> <span class="n">RequestSink</span> <span class="p">{</span>
  <span class="n">MySink</span><span class="p">(</span><span class="n">ApplicationConfiguration</span> <span class="n">config</span><span class="p">)</span> <span class="o">:</span> <span class="k">super</span><span class="p">(</span><span class="n">config</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="n">appConfigValues</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MyConfig</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">configurationFilePath</span><span class="p">);</span>
    <span class="kd">var</span> <span class="n">databaseConnection</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DatabaseConnection</span><span class="p">()</span>
      <span class="p">..</span><span class="n">connectionInfo</span> <span class="o">=</span> <span class="n">appConfigValues</span><span class="p">.</span><span class="n">database</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>(See more details about using configuration files <a href="../configure/">here</a>.)</p>
<p>Isolate specific initialization should also be set in this method:</p>
<div class="codehilite"><pre><span></span><span class="kd">class</span> <span class="nc">MySink</span> <span class="kd">extends</span> <span class="n">RequestSink</span> <span class="p">{</span>
  <span class="n">MySink</span><span class="p">(</span><span class="n">ApplicationConfiguration</span> <span class="n">config</span><span class="p">)</span> <span class="o">:</span> <span class="k">super</span><span class="p">(</span><span class="n">config</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">HTTPCodecRepository</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="k">new</span> <span class="n">ContentType</span><span class="p">(</span><span class="s2">&quot;application&quot;</span><span class="p">,</span> <span class="s2">&quot;xml&quot;</span><span class="p">),</span> <span class="k">new</span> <span class="n">XMLCodec</span><span class="p">());</span>
  <span class="p">}</span>
<span class="p">}</span>  
</pre></div>


<p>All of the properties of a <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/RequestSink-class.html">RequestSink</a> should be initialized in its constructor. This allows the next phase of initialization - setting up routes - to inject these services into controllers. For example, a typical <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/RequestSink-class.html">RequestSink</a> will have some property that holds a database connection; this property should be initialized in the constructor.</p>
<p>A constructor should never call asynchronous functions. Some services require asynchronous initialization - e.g., a database connection has to connect to a database - but those must be fully initialized later. (See a later section on Lazy Services.)</p>
<h3 id="setting-up-routes-in-setuprouter">Setting up Routes in setupRouter</h3>
<p>Once a <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/RequestSink-class.html">RequestSink</a> is instantiated, its <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/RequestSink/setupRouter.html">setupRouter</a> method is invoked. This method takes a <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/Router-class.html">Router</a> that you must configure with all of the routes your application will respond to. (See <a href="../routing/">Routing</a> for more details.)</p>
<p>When setting up routes, you will create many instances of <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/RequestController-class.html">RequestController</a>. Any services these controllers need should be injected in their constructor. For example, <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/Authorizer-class.html">Authorizer</a>s need an instance of <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/AuthServer-class.html">AuthServer</a> to validate a request. The following code is an example of this:</p>
<div class="codehilite"><pre><span></span><span class="kd">class</span> <span class="nc">MySink</span> <span class="kd">extends</span> <span class="n">RequestSink</span> <span class="p">{</span>
  <span class="n">MySink</span><span class="p">(</span><span class="n">ApplicationConfiguration</span> <span class="n">config</span><span class="p">)</span> <span class="o">:</span> <span class="k">super</span><span class="p">(</span><span class="n">config</span><span class="p">)</span> <span class="p">{</span>  
    <span class="n">authServer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AuthServer</span><span class="p">(...);</span>
  <span class="p">}</span>

  <span class="n">AuthServer</span> <span class="n">authServer</span><span class="p">;</span>

  <span class="err">@</span><span class="n">override</span>
  <span class="kt">void</span> <span class="n">setupRouter</span><span class="p">(</span><span class="n">Router</span> <span class="n">router</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">router</span>
        <span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/path&quot;</span><span class="p">)</span>
        <span class="p">.</span><span class="n">pipe</span><span class="p">(</span><span class="k">new</span> <span class="n">Authorizer</span><span class="p">(</span><span class="n">authServer</span><span class="p">))</span>
        <span class="p">.</span><span class="n">listen</span><span class="p">((</span><span class="n">req</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="k">new</span> <span class="n">Response</span><span class="p">.</span><span class="n">ok</span><span class="p">(</span><span class="s2">&quot;Authorized!&quot;</span><span class="p">));</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>This is the only time routes may be set up in an application, as the <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/Router-class.html">Router</a> will restructure its registered routes into an optimized, immutable collection after this method is invoked.</p>
<p>You may not call any asynchronous functions in this this method.</p>
<p>After <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/RequestSink/setupRouter.html">setupRouter</a> has completed, the <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/RequestSink/router.html">RequestSink.router</a> property is set to the router this method configured.</p>
<h3 id="perform-asynchronous-initialization-with-willopen">Perform Asynchronous Initialization with willOpen</h3>
<p>For any initialization that needs to occur asynchronously, you may override <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/RequestSink/willOpen.html">RequestSink.willOpen</a>. This method is asynchronous, and the application will wait for this method to complete before sending any HTTP requests to the request sink. In general, you should avoid using this method and read the later section on Lazy Services.</p>
<h3 id="start-receiving-requests">Start Receiving Requests</h3>
<p>Once an <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/RequestSink-class.html">RequestSink</a> sets up its routes and performs asynchronous initialization, the application will hook up the stream of HTTP requests to the <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/RequestSink-class.html">RequestSink</a> and data will start flowing. Just prior to this, one last method is invoked on <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/RequestSink-class.html">RequestSink</a>, <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/ApplicationServer/didOpen.html">didOpen</a>. This method is a final callback to the <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/RequestSink-class.html">RequestSink</a> that indicates all initialization has completed.</p>
<h2 id="lazy-services">Lazy Services</h2>
<p>An Aqueduct application will probably communicate to other servers and databases. A <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/RequestSink-class.html">RequestSink</a> will have properties to represent these connections. Services like these must open a persistent network connection, a process that is asynchronous by nature. Following the initialization process of a <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/RequestSink-class.html">RequestSink</a>, it may then make sense to create the services in a constructor and then open them in <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/RequestSink/willOpen.html">willOpen</a>.</p>
<p>However, an Aqueduct application will run for a long time. It is probable that connections it uses will occasionally be interrupted. If these connections are only opened when the application first starts, the application will not be able to reopen these connections without restarting it. This would be catastrophic.</p>
<p>For that reason, asynchronous services should manage their own opening behavior. For example, a database connection should open it when it is asked to execute a query. If it has a valid connection, it will go ahead and execute the query. Otherwise, it will establish the connection and then execute the query. The caller doesn't care - they get a <code>Future</code> with the desired data.</p>
<p>The pseudo-code looks something like this:</p>
<div class="codehilite"><pre><span></span><span class="n">Future</span> <span class="n">execute</span><span class="p">(</span><span class="kt">String</span> <span class="n">sql</span><span class="p">)</span> <span class="kd">async</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">connection</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">!</span><span class="n">connection</span><span class="p">.</span><span class="n">isAvailable</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">connection</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Connection</span><span class="p">(...);</span>
    <span class="kd">await</span> <span class="n">connection</span><span class="p">.</span><span class="n">open</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="kd">await</span> <span class="n">connection</span><span class="p">.</span><span class="n">executeSQL</span><span class="p">(</span><span class="n">sql</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>


<p>From the perspective of an <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/HTTPController-class.html">HTTPController</a>, it doesn't care about the underlying connection. It invokes <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/PersistentStore/execute.html">execute</a>, and the connection object figures out if it needs to establish a connection first:</p>
<div class="codehilite"><pre><span></span><span class="err">@</span><span class="n">httpGet</span> <span class="n">getThings</span><span class="p">()</span> <span class="kd">async</span> <span class="p">{</span>
  <span class="c1">// May or may not create a new connection, but will either return</span>
  <span class="c1">// some things or throw an error.</span>
  <span class="kd">var</span> <span class="n">things</span> <span class="o">=</span> <span class="kd">await</span> <span class="n">connection</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select * from things&quot;</span><span class="p">);</span>

  <span class="p">...</span>
<span class="p">}</span>
</pre></div>


<h2 id="multi-threaded-aqueduct-applications">Multi-threaded Aqueduct Applications</h2>
<p>Aqueduct applications can - and should - be spread across a number of threads. This allows an application to take advantage of multiple CPUs and serve requests faster. In Dart, threads are called <em>isolates</em> (and have some slight nuances to them that makes the different than a traditional thread). Spreading requests across isolates is an architectural tenet of Aqueduct applications.</p>
<p>When an application is started with <code>aqueduct serve</code>, a option indicates how many isolates the application should run on.</p>
<div class="codehilite"><pre><span></span>aqueduct serve --isolates 3
</pre></div>


<p>The number of isolates defaults to 3. An application will spawn that many isolates and create an instance of <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/RequestSink-class.html">RequestSink</a> for each. When an HTTP request is received, one of the isolates - and its <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/RequestSink-class.html">RequestSink</a> - will receive the request while the others will never see it. Each isolate works independently of each other, running as their own "web server" within a web server. Because a <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/RequestSink-class.html">RequestSink</a> initializes itself in the exact same way on each isolate, each isolate behaves exactly the same way.</p>
<p>An isolate can't share memory with another isolate. Therefore, each <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/RequestSink-class.html">RequestSink</a> instance has its own set of services, like database connections. This behavior also makes connection pooling implicit - the connections are effectively pooled by the fact that there is a pool of <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/RequestSink-class.html">RequestSink</a>s. If a <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/RequestSink-class.html">RequestSink</a> creates a database connection and an application is started with four isolates, there will be four database connections total.</p>
<p>However, there are times where you want your own pool or you want to share a single service across multiple isolates. For example, an API that must register with some other server (like in a system with an event bus) or must maintain a single persistent connection (like the error pipe to Apple's Push Notification Service or a streaming connection to Nest). These types of services should be instantiated in <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/RequestSink/initializeApplication.html">initializeApplication</a>.</p>
<h2 id="the-application-object">The Application Object</h2>
<p>Hidden in all of this discussion is the <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/Application-class.html">Application&lt;T&gt;</a> object. Because the <code>aqueduct serve</code> command manages creating <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/Application-class.html">Application&lt;T&gt;</a> instances, your code rarely concerns itself with this type.</p>
<p>An <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/Application-class.html">Application&lt;T&gt;</a> is the top-level object in an Aqueduct application; it setups up HTTP listeners and sends their requests to <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/RequestSink-class.html">RequestSink</a> instances. The <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/Application-class.html">Application&lt;T&gt;</a> itself is just a generic container for <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/RequestSink-class.html">RequestSink</a>s; it doesn't do much other than kick everything off.</p>
<p>The application's <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/Application/start.html">start</a> method will initialize at least one instance of the application's <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/RequestSink-class.html">RequestSink</a>. If something goes wrong during this initialization process, the application will throw an exception and halt starting the server. For example, setting up an invalid route in a <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/RequestSink-class.html">RequestSink</a> subclass would trigger this type of startup exception.</p>
<p>An <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/Application-class.html">Application&lt;T&gt;</a> has a number of options that determine how it will listen for HTTP requests, such as which port it is listening on or the SSL certificate it will use. These values are available in the application's <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/Application/configuration.html">configuration</a> property, an instance of <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/ApplicationConfiguration-class.html">ApplicationConfiguration</a>.</p>
<p>Properties of an <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/ApplicationConfiguration-class.html">ApplicationConfiguration</a> and <a href="https://www.dartdocs.org/documentation/aqueduct/latest/aqueduct/Application-class.html">Application&lt;T&gt;</a> are provided through the <code>aqueduct serve</code> command-line options.</p>
                
                  
                
              
              
                
              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../routing/" title="Routing" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Routing
              </span>
            </div>
          </a>
        
        
          <a href="../http_controller/" title="Handling Requests: HTTPController" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Handling Requests: HTTPController
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Built by stable|kernel
          </div>
        
        powered by
        <a href="http://www.mkdocs.org" title="MkDocs">MkDocs</a>
        and
        <a href="http://squidfunk.github.io/mkdocs-material/" title="Material for MkDocs">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application-3700c4cc12.js"></script>
      
      
      <script>app.initialize({url:{base:"../.."}})</script>
      
    
    
      
      <script>!function(e,t,a,n,o,c,i){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,c=t.createElement(a),i=t.getElementsByTagName(a)[0],c.async=1,c.src=n,i.parentNode.insertBefore(c,i)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-41269877-2","aqueduct.io"),ga("set","anonymizeIp",!0),ga("send","pageview");var links=document.getElementsByTagName("a");Array.prototype.map.call(links,function(e){e.host!=document.location.host&&e.addEventListener("click",function(){var t=e.getAttribute("data-md-action")||"follow";ga("send","event","outbound",t,e.href)})});var query=document.forms.search.query;query.addEventListener("blur",function(){if(this.value){var e=document.location.pathname;ga("send","pageview",e+"?q="+this.value)}})</script>
      
    
  </body>
</html>